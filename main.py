import os
import json
import random
import google.generativeai as genai
from github import Github

# --- SETUP & CONFIGURATION ---
GITHUB_TOKEN = os.getenv('GITHUB_TOKEN')
GEMINI_API_KEY = os.getenv('GEMINI_API_KEY')
REPO_NAME = os.getenv('REPO_NAME')
PR_NUMBER = int(os.getenv('PR_NUMBER'))

# Use the Free Tier friendly alias
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-flash-latest')

def get_panic_gif(issue_count):
    if issue_count == 0:
        # Success Kid (Wikimedia)
        return "https://upload.wikimedia.org/wikipedia/en/f/ff/SuccessKid.jpg"
    elif issue_count < 5:
        # Concerned Ape / Thinking
        return "https://upload.wikimedia.org/wikipedia/commons/3/30/Filosof_penseur.jpg"
    else:
        # The Scream (Panic)
        return "https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/The_Scream.jpg/471px-The_Scream.jpg"

def get_diff(repo, pr_number):
    pr = repo.get_pull(pr_number)
    diff_content = ""
    print(f"Processing PR #{pr_number}...")

    for file in pr.get_files():
        if file.filename.endswith(('.png', '.jpg', '.lock', '.json', '.svg')):
            print(f"Skipping {file.filename}")
            continue
        diff_content += f"\nFile: {file.filename}\n{file.patch}\n"
    
    return pr, diff_content

def analyze_diff(diff):
    prompt = f"""
    You are a Senior Software Engineer doing a code review.
    Analyze the following git diffs.
    
    YOUR RULES:
    1. Focus on SUBSTANTIAL issues: Bugs, Security, Performance.
    2. IGNORE trivial issues: Formatting, missing comments.
    3. If the code looks good, return an empty list.
    
    OUTPUT FORMAT:
    Respond strictly in JSON format as a list of objects:
    [
        {{"file": "filename.py", "line": 10, "comment": "Issue description"}}
    ]

    Here is the diff:
    {diff}
    """
    response = model.generate_content(prompt)
    clean_response = response.text.replace("```json", "").replace("```", "").strip()
    return clean_response

def post_comment(pr, analysis_json):
    try:
        comments = json.loads(analysis_json)
        issue_count = len(comments)
        
        # 1. Get the Image
        gif_url = get_panic_gif(issue_count)
        
        # 2. Build the Header
        comment_body = f"## ðŸ¤– AI Code Reviewer Report\n"
        comment_body += f"![Reaction]({gif_url})\n\n" # Inject Image Here
        
        # 3. Build the Body
        if issue_count == 0:
            comment_body += "âœ… **LGTM!** No critical issues found."
        else:
            comment_body += f"### ðŸš¨ I found {issue_count} issues:\n\n"
            for item in comments:
                comment_body += f"- **{item['file']}** (Line {item.get('line', '?')}): {item['comment']}\n"
            
            comment_body += "\n---\n*Generated by Gemini 1.5 Flash*"

        pr.create_issue_comment(comment_body)
        print("Comment posted successfully.")

    except json.JSONDecodeError:
        print("Failed to parse AI response.")
        pr.create_issue_comment(f"## ðŸ¤– AI Review (Raw Output)\n\n{analysis_json}")

if __name__ == "__main__":
    g = Github(GITHUB_TOKEN)
    repo = g.get_repo(REPO_NAME)
    pr, diff_data = get_diff(repo, PR_NUMBER)

    if not diff_data:
        print("No code changes detected.")
    else:
        print("Analyzing with Gemini...")
        analysis = analyze_diff(diff_data)
        post_comment(pr, analysis)